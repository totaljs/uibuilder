@{layout('')}

<!DOCTYPE html>
<html>
<head>
	<title>Total.js UI Builder</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
	<meta http-equiv="X-UA-Compatible" content="IE=10" />
	<meta name="robots" content="all,follow" />
	<link href="@{'%cdn'}/spa.min@19.css" rel="stylesheet" type="text/css" />
	<script src="@{'%cdn'}/spa.min@19.js"></script>
	<script src="@{REPO.ui}"></script>
	@{import('default.css + ui.css', 'ui.js + func.js + uibuilder.js')}
</head>
<body>

	<ui-component name="LAZY menu" config="style:2"></ui-component>
	<ui-component name="LAZY icons"></ui-component>
	<ui-component name="LAZY directory" config="placeholder:@(Search)"></ui-component>
	<ui-component name="LAZY approve" config="cancel:@(Cancel)"></ui-component>
	<ui-component name="LAZY colorpicker"></ui-component>
	<ui-component name="LAZY floatinginput"></ui-component>
	<ui-component name="LAZY notify" config="position:bottom right"></ui-component>
	<ui-component name="LAZY notifybar"></ui-component>
	<ui-component name="LAZY clipboard"></ui-component>
	<ui-component name="LAZY fileuploader"></ui-component>
	<ui-component name="LAZY floatingbox"></ui-component>
	<ui-component name="LAZY sounds" config="volume:10"></ui-component>
	<ui-component name="LAZY message" config="style:2"></ui-component>
	<ui-component name="LAZY floatinginput"></ui-component>
	<ui-component name="LAZY filesaver"></ui-component>
	<ui-component name="LAZY filereader"></ui-component>
	<ui-component name="LAZY prompt" config="cancel:@(Cancel);submit:@(OK)"></ui-component>

	<ui-component name="datepicker" config="today:@(Today);days:@(Sunday,Monday,Tuesday,Wednesday,Thursday,Friday,Saturday);clear:@(Clear);months:@(January,February,March,April,May,Juny,July,August,September,October,November,December)"></ui-component>
	<ui-component name="windows" path="common.windows" config="zindex:30"></ui-component>
	<ui-component name="mainprogress" path="common.progress"></ui-component>
	<ui-component name="markdown"></ui-component>
	<ui-component name="dropfiles" class="hidden" config="check:uibuilder_drop_check;exec:uibuilder_drop">@(Drop .json schema or .html component file)</ui-component>
	<ui-component name="exec"></ui-component>
	<ui-component name="locale"></ui-component>
	<ui-component name="loading"></ui-component>
	<ui-component name="shortcuts"></ui-component>
	<ui-component name="edit"></ui-component>

	<ui-bind path="app.ready" config="visible" class="invisible block">
		<ui-component name="layout" path="common.layout" config="parent:window">

			<script type="text/plain">
				{
					top: { size: 49 },
					left: { size: 222, resize: true },
					main: {}
				}
			</script>

			<section data-type="top">
				<div class="header">

					<ui-bind path="common.allowclose" config="show" class="hidden pull-right">
						<button class="exec red" data-exec="uibuilder_close" title="@(Close)"><i class="ti ti-times"></i></button>
					</ui-bind>

					<div class="pull-right" style="border-right:0">
						<div class="replace">
							<button class="exec" data-exec="uibuilder_replace" title="@(Replace source-code)"><i class="ti ti-recycle"></i></button>
						</div>
						<button class="exec" data-exec="uibuilder_edit" title="@(Edit source-code)"><i class="ti ti-pencil"></i></button>
						<button class="exec" data-exec="uibuilder_download" title="@(Download source-code)"><i class="ti ti-download"></i></button>
						<a href="https://docs.totaljs.com/uibuilder/" title="@(Documentation: Total.js Platform)" target="_blank" class="special"><i class="ti ti-book"></i></a>
					</div>

					<div>
						<button class="apply exec" data-exec="uibuilder_save"><i class="ti ti-save"></i><span>@(SAVE)</span></button>
					</div>

					<div style="margin-right:8px">
						<button class="exec" data-exec="uibuilder_render" title="@(Preview)" style="background-color:#FFEBFE"><i class="ti ti-flask"></i></button>
						<ui-bind path="!app.schema.editor" config="hide:value.autopublish || value.compile === false" class="hidden">
							<button class="exec" data-exec="uibuilder_publish" title="@(Publish)"><i class="ti ti-box"></i></button>
						</ui-bind>
						<ui-bind path="app.schema.editor.settings" config="show:value!=false&&value!=0" class="hidden">
							<button class="exec" data-exec="uibuilder_settings" title="@(Global settings)"><i class="ti ti-cog"></i></button>
						</ui-bind>
					</div>

					<button class="exec" data-exec="uibuilder_device" title="@(Display settings)"><i class="ti ti-window"></i></button>
					<button class="exec" data-exec="uibuilder_io" title="@(Inputs / Outputs)"><i class="ti ti-code-branch"></i></button>
					<!--
					<button class="exec" data-exec="uibuilder_darkmode" title="@(Toggle between light/dark mode)" is="is-bind" path="common.darkmode" config=".selected"><i class="ti ti-adjust"></i></button>
					-->
					<button class="exec" data-exec="uibuilder_redraw" title="@(Re-load components)"><i class="ti ti-sync"></i></button>
				</div>
			</section>

			<section data-type="left">
				<ui-component name="searchinput" path="%searchcomponents" config="type:search;placeholder:@(Search components);autofocus:2"></ui-component>
				<div style="margin:5px 10px 8px 14px" class="fs11">
					<div><span class="exec link" data-exec="uibuilder_components"><i class="ti ti-cloud-download mr5"></i>@(Import components)</span></div>
				</div>
				<ui-component name="viewbox" config="parent:window;margin:104;scrollbarshadow:1">
					<ui-component name="search" path="%searchcomponents" config="selector:figure">
						<ui-bind path="common.groups" config="template" class="block components">
							<script type="text/html">
							{{ foreach g in value }}
								<div class="caption" data-search="">{{ g.id }}</div>
								{{ foreach m in g.items }}
								<figure draggable="true" class="draggable exec exec3{{ if m.isexternal }} external{{ fi }}" data-exec3="uibuilder_contextmenu" data-exec="component_readme" data-id="{{ m.id }}" data-search="{{ m.name }}">
									<i class="{{ m.icon }}"></i>
									<div class="name">{{ m.name }}</div>
								</figure>
								{{ end }}
							{{ end }}
							</script>
						</ui-bind>
					</ui-component>
					<br />
				</ui-component>
			</section>

			<section data-type="main">
				<ui-component name="viewbox" path="app" config="parent:window;margin:50;scrollbarshadow:1;visibleX:1;visibleY:1;$id:mainviewbox">
					<div id="dappcontainer">
						<ui-component id="dapp" name="uibuildereditor" config="exec:func;ondrop:component_drop;dblclick:opensettings;cms:cms_selected"></ui-component>
					</div>
				</ui-component>
			</section>

		</ui-component>

	</ui-bind>

	<ui-component name="box" path="common.form" config="if:settingsform;width:840;title:@(Settings);icon:ti ti-cog;submit:settings_submit;scrollbar:0;reload:settings_reload;autofocus:1">
		<ui-component name="stash" path="settingsform.componentid" config="load:settings_load" class="settingsform"></ui-component>
	</ui-component>

	<ui-component name="importer" path="common.form" config="if:appsettingsform;url:/forms/settings.html"></ui-component>
	<ui-component name="importer" path="common.form" config="if:templatesform;url:/forms/templates.html"></ui-component>
	<ui-component name="importer" path="common.form" config="if:componentsform;url:/forms/components.html"></ui-component>
	<ui-component name="importer" path="common.form" config="if:ioform;url:/forms/io.html"></ui-component>
	<ui-component name="importer" path="common.form" config="if:formimport;url:/forms/import.html"></ui-component>
	<ui-component name="importer" path="common.form" config="if:formimage;url:/forms/image.html"></ui-component>
	<ui-component name="importer" path="common.form" config="if:formpaste;url:/forms/paste.html"></ui-component>
	<ui-component name="importer" path="common.form" config="if:formcomponent;url:/forms/component.html"></ui-component>
	<ui-component name="importer" path="common.form2" config="if:formlink;url:/forms/link.html"></ui-component>
	<ui-component name="importer" path="common.form2" config="if:formattr;url:/forms/attr.html"></ui-component>
	<ui-component name="importer" path="common.form2" config="if:formtotaldb;url:/forms/totaldb.html"></ui-component>
	<ui-component name="importer" path="common.form" config="if:formcode;url:/forms/code.html"></ui-component>
	<ui-component name="importer" path="common.form" config="if:formschema;url:/forms/schema.html"></ui-component>

	<div id="CMS_panel" class="hidden">
		<nav>
			<button class="exec" data-exec="cms_edit" name="edit" title="@(Edit content)"><i class="ti ti-pencil"></i></button>
			<button class="exec" data-exec="cms_link" name="link" title="@(Edit link)"><i class="ti ti-link"></i></button>
			<button class="exec" data-exec="cms_attrs" name="attrs" title="@(Change attributes)"><i class="ti ti-quote-left"></i></button>
			<button class="exec" data-exec="cms_repeat" name="repeat" title="@(Clone)"><i class="ti ti-clone"></i></button>
			<button class="exec" data-exec="cms_remove" name="remove" title="@(Remove)"><i class="ti ti-trash"></i></button>
			<button class="exec red" data-exec="cms_hide" name="hide" title="@(Hide)"><i class="ti ti-caret-square-down"></i></button>
		</nav>
	</div>

	<form id="uibuilderrender" method="POST" target="_blank">
		<input name="data" type="hidden" />
	</form>

	<script>

		EXTENSION('input', function(instance, config) {
			if (config.dirsource === '#outputs' || config.dirsource === '#inputs' || config.dirsource === '#paths' || config.dirsource === 'DEF.cl.inputs' || config.dirsource === 'DEF.cl.outputs' || config.dirsource === 'DEF.cl.paths')
				config.dirraw = 1;
		});

		var common = {};
		var settingsform = {};

		DEF.language = '';
		DEF.cl.inputs = [];
		DEF.cl.outputs = [];

		UIBuilder.editor = true;
		UIBuilder.origin = location.origin;

		common.progress = 0;
		common.windows = [];
		common.components = [];
		common.iframeapps = [];
		common.paths = '';
		common.codes = '';
		common.apps = '';
		common.views = '';
		common.callbacks = {};
		common.componentsdb = NAV.query.components || 'https://cdn.componentator.com/uibuilder/db.json';

		if (NAV.query.color)
			APPEARANCE({ color: NAV.query.color });

		CACHEPATH('common.darkmode', '1 year');

		ON('@flag showloading', function() {
			SETTER('loading/show');
		});

		ON('@flag hideloading', function() {
			SETTER('loading/hide', 500);
		});

		ON('ERROR', function(err) {
			if (err instanceof Array)
				err = err[0].error || err[0].message;
			else
				err = err.toString();
			SETTER('notify/warning @hideloading', Thelpers.encode(err) || 'Unexpected error');
		});

		function settings_reload(form) {

			cms_hide();

			var id = settingsform.componentid;
			var data = settingsform[id];
			var com = app.components[id];

			form.reconfigure({ title: '@(Settings:) ' + com.name });

			if (!data.name)
				data.name = com.name;

			EXEC('settingsform.' + id + '/reload', data);
		}

		$(W).on('message', function(e) {
			e = e.originalEvent;

			var msg = e.data;

			if (typeof(msg) === 'string')
				msg = PARSE(msg);

			if (!msg.uibuilder)
				return;

			switch (msg.TYPE) {
				case 'init':

					UIBuilder.origin = e.origin;

					common.upload = msg.upload;
					common.iframeapps = msg.apps || [];
					common.iframeviews = msg.views || [];
					common.iframecodes = msg.codes || [];
					common.iframepaths = msg.paths || [];

					if (msg.components)
						common.componentsdb = msg.components;

					DEF.cl.usergroups = msg.groups || [];

					SET('DEF.cl.views', common.iframeviews.slice(0));
					SET('DEF.cl.paths', prepare_external_paths(common.iframepaths.slice(0)));
					SET('DEF.cl.codes', common.iframecodes.slice(0));
					SET('DEF.cl.apps', common.iframeapps.slice(0));

					if (msg.data && msg.data.id) {
						UIBuilder.data = msg.data;
						uibuilder_redraw();
					} else
						SET('common.form', 'templatesform');

					break;

				case 'redraw':
					if (msg.data)
						UIBuilder.data = msg.data;
					uibuilder_redraw(msg.data ? false : true);
					break;

				case 'refresh':

					if (msg.upload)
						common.upload = msg.upload;

					if (msg.apps) {
						common.iframeapps = msg.apps;
						SET('DEF.cl.apps', common.iframeapps.slice(0));
					}

					if (msg.views) {
						common.iframeviews = msg.views;
						SET('DEF.cl.views', common.iframeviews.slice(0));
					}

					if (msg.codes) {
						common.iframecodes = msg.codes;
						SET('DEF.cl.codes', common.iframecodes.slice(0));
					}

					if (msg.paths) {
						common.iframepaths = msg.paths;
						SET('DEF.cl.paths', prepare_external_paths(common.iframepaths.slice(0)));
					}

					if (msg.groups)
						SET('DEF.cl.usergroups', msg.groups);

					if (msg.components)
						common.componentsdb = msg.components;

					uibuilder_rebuildpaths();
					break;

				case 'callback':
					var cb = common.callbacks[msg.id];
					if (cb) {
						cb(msg.data);
						delete common.callbacks[msg.id];
					}
					break;
			}

		});

		function settings_load(id, next) {
			var com = app.components[id];
			if (com) {

				var done = function(response, err) {

					if (err)
						response = '';

					if (typeof(response) !== 'string')
						response = '';

					response = ADAPT(null, null, response.replace(/CLASS/g, com.cls));

					var beg = response.indexOf('<scr' + 'ipt>');
					if (beg !== -1) {
						response = response.replace(/PLUGIN\((\s)?function/g, 'PLUGIN(\'settingsform.' + id + '\', function');
						var end = response.indexOf('</scr' + 'ipt>', beg + 8);
						var scr = response.substring(beg + 8, end).trim();
						response = response.substring(0, beg) + response.substring(end);
						new Function(scr)();
					}

					next('<ui-plugin path="settingsform.{0}" class="{2}_settings"><ui-component name="ready" config="delay:300" class="invisible"><ui-component name="viewbox" path="common.form" config="scrollbar:1;scrollbarshadow:1;margin:70;parent:auto"><div class="padding main npb"><div class="grid-2"><div class="m"><ui-component name="input" path="?.name" config="required:1;placeholder:@(Component name);maxlength:10000">@(Name)</ui-component><div class="help">ID: <ui-bind path="?.$id" config="text" class="b monospace"></ui-bind></div></div><div class="m"><ui-component name="input" path="?.path" config="dirsource:DEF.cl.paths2;dircustom:1;dirraw:1;dirplaceholder:@(Search);dirempty:@(Empty);monospace:1;placeholder:@(Select a component);maxlength:10000">@(Read value from)</ui-component><div class="help"><span class="exec link mr5" data-exec="settigns_generatepath"><i class="ti ti-magic mr5"></i>@(Generate)</span>@(or)<span class="exec link ml5 mr5" data-exec="settings_clearpath"><i class="ti ti-clean mr5"></i>@(Clear)</span>@(or)<span class="exec link ml5" data-exec="settings_copypath"><i class="ti ti-copy mr5"></i>@(Copy)</span></div></div></div></div>{1}</ui-component><nav><ui-component name="validate" path="?" class="buttons"><button name="submit" disabled><i class="ti ti-check-circle"></i>@(SUBMIT)</button><button name="cancel">@(Cancel)</button></ui-component></nav></ui-component></ui-plugin>'.format(id, response, com.cls));
				};

				if (com.settings) {
					if (com.settings.indexOf('<') === -1) {
						var url = com.settings;
						if (url.substring(0, 6) === 'base64') {
							done(decodeURIComponent(atob(url.substring(7))));
						} else {
							if (url.charAt(0) === '/')
								url = UIBuilder.origin + url;
							AJAX('GET ' + url.format(com.id), done);
						}
					} else
						done(com.settings);
				} else
					done(com.settings);

			} else
				next('');
		}

		function settings_copypath(el) {
			var path = el.scope().get('path');
			if (path) {
				SETTER('clipboard/copy', path);
				SETTER('notify/success', '@(Copied.)');
			}
		}

		function settings_clearpath(el) {
			el.scope().set('path', '');
		}

		function settigns_generatepath(el) {
			var scope = el.scope();
			scope.set('path', scope.get().name.slug().replace(/-/g, ''));
		}

		function settings_submit(hide) {

			var data = CLONE(settingsform[settingsform.componentid]);
			delete data.$id;

			var instance = app.instances.findItem('id', settingsform.id);
			instance.reconfigure(data);

			if (UIBuilder.version < 1.16) {
				// It's part of UI builder in +1.16
				for (var item of app.instances)
					item.events.refresh && item.emit('refresh', { type: 'configure', item: instance });
				app.clean();
			}

			hide();
		}

		ON('ready', function() {

			common.darkmode && $('body').aclass('ui-dark');

			if (top !== W) {
				// iframe
				SET('common.iframe', true);
				SET('common.allowclose', NAV.query.hideclose !== '1');
				FUNC.send({ TYPE: 'ready' });
				return;
			}

			var url = NAV.query.url;

			if (!url) {

				var base64 = NAV.query.base64;
				if (base64) {
					var data = PARSE(decodeURIComponent(atob(base64)));
					if (data) {
						UIBuilder.data = response;
						uibuilder_redraw();
						return;
					}
				}

				SET('common.form', 'templatesform');
				return;
			}

			AJAX('GET ' + url, function(response, err) {
				if (err) {
					SET('common.form', 'templatesform');
					SETTER('message/warning @hideloading', 'Invalid source: ' + err);
				} else {
					UIBuilder.data = response;
					uibuilder_redraw();
				}
			});
		});

		function uibuilder_io() {
			SET('common.form', 'ioform');
		}

		function uibuilder_darkmode() {
			var el = $('body');
			var c = 'ui-dark';
			el.tclass(c);
			SET('common.darkmode', el.hclass(c));
		}

		function uibuilder_rebuildpaths() {
			common.rebuildpathstimeout && clearTimeout(common.rebuildpathstimeout);
			common.rebuildpathstimeout = setTimeout(uibuilder_rebuildpaths_force, 10);
		}

		function uibuilder_rebuildpaths_force() {

			common.rebuildpathstimeout = null;
			DEF.cl.paths = DEF.cl.paths.remove('internal', true);
			DEF.cl.datasource = [];

			var arr = [];

			for (var instance of app.instances) {
				if (instance.component.follow)
					arr.push({ id: '@' + instance.id, name: '<span class="badge badge-small mr5 badge-gray monospace">@(component)</span>' + instance.config.name + '<span class="fs11 silver ml5">' + instance.id + ' / ' + instance.component.name + '</span>', sort: instance.config.name, text: instance.config.name, internal: true });
			}

			arr.quicksort('sort');

			DEF.cl.paths.push.apply(DEF.cl.paths, arr);

			if (DEF.cl.views) {
				for (var view of DEF.cl.views)
					arr.push({ id: '#' + view.id, name: '<span class="badge badge-small mr5 badge-yellow monospace">@(view)</span>' + view.name, sort: view.name });
			}

			DEF.cl.datasource.push.apply(DEF.cl.datasource, DEF.cl.codes);
			DEF.cl.datasource.push.apply(DEF.cl.datasource, arr);

			UPD('DEF.cl.paths');
			UPD('DEF.cl.datasource');

			for (var instance of app.instances)
				instance.events.refresh && instance.emit('refresh', { type: 'paths' });
		}

		function uibuilder_redraw(el, callback) {

			if (el) {
				if (el instanceof jQuery) {
					var cls = 'ti-spin';
					el.find('i').aclass(cls).rclass(cls, 2000);
				}
				UIBuilder.data.children = app.stringify().children;
			}

			SETTER('loading/show');

			common.paths = '';
			common.codes = '';
			common.views = '';

			UIBuilder.build('#dapp', UIBuilder.data, function(response) {

				SETTER('stash/clear');
				SETTER('loading/hide', 1000);

				W.app = response;

				var arr = [];
				var groups = {};

				for (var key in response.components) {
					var com = response.components[key];

					if (com.hidden)
						continue;

					var g = com.group || '$';
					if (groups[g])
						groups[g].push(com);
					else
						groups[g] = [com];
					arr.push(com);
				}

				var arr2 = [];

				for (var key in groups) {
					var items = groups[key];
					items.quicksort('name');
					arr2.push({ id: key === '$' ? '' : key, items: items });
				}

				arr2.quicksort('id');

				SET('common.components', arr);
				SET('common.groups', arr2);
				UPD('app');

				if (typeof(callback) === 'function')
					callback();
			});
		}

		function opensettings(el) {

			var com = el[0].uibuilder;

			if (com.meta.readonly || com.component.children)
				return;

			var componentid = com.component.id;

			var config = CLONE(com.config);
			config.$id = com.id;

			cms_hide();

			UIBuilder.selected = com;

			var paths = CLONE(DEF.cl.paths);
			var paths2 = {};

			for (var instance of app.instances) {
				if (instance.config.path && instance.config.path.charAt(0) !== '@')
					paths2[instance.config.path] = 1;
			}

			for (var key in paths2)
				paths.push({ id: key, name: '<span class="badge badge-small mr5 badge-purple">@(path)</span><span class="monospace">{0}</span>'.format(key) });

			com.emit('settings', config);

			SET('#paths2', paths);
			SET('settingsform.id', com.id);
			SET('settingsform.componentid', componentid);
			SET('settingsform.' + componentid + ' @reset', config);
			SET('common.form', 'settingsform');
		}

		function component_readme(el) {
			var id = ATTRD(el);
			var com = app.components[id];
			FUNC.readme(com.name, com.readme || '@(Without readme)');
		}

		function component_copy(instance) {

			var meta = app.stringify(instance.element);
			delete meta.instances;

			for (var key in meta.components) {
				if (meta.components[key].charAt(0) === '@')
					delete meta.components[key];
			}

			cms_hide();
			EXEC('-clipboard/copy', 'uibuilder://' + ENCRYPT(meta, 'uibuilder', 'copy'));
			EXEC('-notify/success', '@(The component has been copied to the clipboard.)');
		}

		function component_clone(instance) {

			var meta = app.stringify(instance.element).children;

			meta.id = UIBuilder.makeid(instance.component);

			var updateid = function(children) {
				for (var item of children) {
					for (var m of item) {
						m.id = UIBuilder.makeid(typeof(m.component) === 'string' ? app.components[m.component] : m.component);
						updateid(m.children);
					}
				}
			};

			cms_hide();
			updateid(meta.children);

			var parent = instance.parent.element;
			var parentid = parent.attrd('id');
			var containerindex = instance.element.closest('.UI_components').attrd('index');
			var target = instance.element;
			var position = target[0] === parent[0] ? null : (NODEINDEXOF(target[0]) + 1);
			app.add(parentid, containerindex, meta, position, null, null, true);
			app.clean();
		}

		function component_move(instance, up) {

			var meta = app.stringify(instance.element).children;
			var parent = instance.parent.element;
			var parentid = parent.attrd('id');
			var containerindex = instance.element.closest('.UI_components').attrd('index');
			var target = instance.element;
			var position = target[0] === parent[0] ? null : (NODEINDEXOF(target[0]) + (up ? -1 : 2));

			if (position === -1)
				return;

			cms_hide();
			app.add(parentid, containerindex, meta, position);
			instance.element.remove();
			app.clean();
		}

		function component_drop(meta) {

			cms_hide();

			var parent = meta.container.closest('.UI_component');
			var parentid = parent.attrd('id');
			var containerindex = meta.container.attrd('index');
			var target = meta.target.hclass('UI_component') ? meta.target : meta.target.closest('.UI_component');

			if (!target[0])
				return;

			var position = target[0] === parent[0] ? null : (NODEINDEXOF(target[0]) + 1);
			var config;
			var node = meta.element;

			if (!node.hclass('UI_component'))
				node = node.closest('.UI_component');

			instance = node[0] ? node[0].uibuilder : null;

			if (!meta.element.hclass('draggable') && !instance)
				return;

			// Existing component
			if (instance) {

				// Same element or child
				if (instance.dom === target[0] || instance.dom.contains(parent[0]))
					return;

				var data = app.stringify(instance.element);
				var metadata = data.children;
				app.add(parentid, containerindex, metadata, position, null, null, true);
				node.remove();
				app.clean();

			} else {

				var comid = ATTRD(meta.element);
				var com = app.components[comid];

				if (!com) {
					WARN('The component "{0}" not found in the component list'.format(comid));
					return;
				}

				var metadata = null;

				if (com.floating) {
					var offset = $('#dappcontainer').offset();
					metadata = { x: meta.pageX - offset.left, y: meta.pageY - offset.top, zindex: app.zindex + 1 };
					parentid = app.instances[0].id;
				}

				app.add(parentid, containerindex, comid, position, null, metadata, true);
			}
		}

		function uibuilder_compile_fork(app, used, meta) {
			for (var instance of app.instances) {
				var declaration = instance.component.render || app.schema.components[instance.component.id];
				if (declaration)
					used[instance.component.id] = meta.editor.local ? '@' : ((meta.editor.download && declaration.indexOf('http') === -1 ? (UIBuilder.origin || 'https://uibuilder.totaljs.com') : '') + declaration.format(instance.component.id));
				if (instance.fork)
					uibuilder_compile_fork(instance.fork, used, meta);
			}
		}

		function uibuilder_compile(callback, skiplocal) {

			SETTER('loading/show');
			cms_hide();

			var meta = CLONE(app.schema);
			var data = app.stringify(function(item) {
				return !!item.component.render;
			}, true);

			if (skiplocal)
				meta.editor.local = false;

			meta.children = data.children;
			meta.inputs = app.inputs;
			meta.outputs = app.outputs;

			var used = {};

			uibuilder_compile_fork(app, used, meta);

			if (meta.editor && meta.editor.download && !meta.editor.local) {
				var arr = Object.keys(used);
				arr.wait(function(key, next) {

					var com = app.components[key];
					var render = used[key];

					if (render.substring(0, 6) === 'base64') {
						used[key] = 'base64 ' + btoa(encodeURIComponent(uibuilder_preparerender(com, decodeURIComponent(atob(render.substring(7).trim())))));
						next();
					} else {
						AJAX('GET ' + render.format(key), function(response) {
							if (response && typeof(response) === 'string')
								used[key] = 'base64 ' + btoa(encodeURIComponent(uibuilder_preparerender(com, response)));
							next();
						});
					}

				}, function() {
					meta.components = used;
					callback(meta);
				}, 3);
			} else {

				for (var key in used) {
					var render = used[key];
					if (render.substring(0, 6) === 'base64')
						used[key] = 'base64 ' + btoa(encodeURIComponent(uibuilder_preparerender(app.components[key], decodeURIComponent(atob(render.substring(7).trim())))));
				}

				meta.components = used;
				callback(meta);
			}
		}

		function uibuilder_publish(element) {

			cms_hide();

			if (common.iframe) {
				uibuilder_compile(function(meta) {
					var data = meta.editor;

					if (meta.cssoutput)
						meta.css = meta.cssoutput;

					delete meta.editor;
					delete meta.cssoutput;
					delete meta.csspreview;
					SETTER('loading/hide', 500);
					FUNC.send({ TYPE: 'publish', data: meta });
				});
				return;
			}

			var type = '';

			var compile = function() {
				uibuilder_compile(function(meta) {
					var data = meta.editor;

					if (meta.cssoutput)
						meta.css = meta.cssoutput;

					delete meta.editor;
					delete meta.cssoutput;
					delete meta.csspreview;

					if (app.schema.editor && app.schema.editor.publish) {
						AJAX('POST ' + data.publish + ' urlencoded', { data: JSON.stringify(meta) }, ERROR(ASETTER('notify/success @hideloading', '@(Done, published!)')));
					} else {
						if (!type || type === 'download') {
							SETTER('filesaver/save', meta.name + '_render.json', JSON.stringify(meta, null, '\t'));
						} else if (type === 'html') {
							AJAX('GET /render.txt', function(response) {
								response = response.replace('UIBUILDERDATA', JSON.stringify(meta));
								SETTER('filesaver/save', meta.name + '_render.html', response);
							});
						} else if (type === 'htmlify') {
							SETTER('clipboard/copy', FUNC.htmlify(meta));
							SETTER('notify/success', '@(Copied.)');
						}

						SETTER('loading/hide', 1000);
					}
				});
			};

			if (app.schema.editor.autopublish)
				compile();
			else {

				var next = () => SETTER('approve/show', '@(Are you sure you want to publish current design?)', '"ti ti-check-circle" @(PUBLISH)', compile);

				if (!element || (app.schema.editor && app.schema.editor.publish)) {
					next();
					return;
				}

				var opt = {};
				opt.element = element;
				opt.items = [];
				opt.items.push({ id: 'html', name: '@(Download HTML)', icon: 'ti ti-html5' });
				opt.items.push({ id: 'download', name: '@(Download JSON)', icon: 'ti ti-download' });
				opt.items.push('-');
				opt.items.push({ id: 'htmlify', name: '@(Copy as HTML elements)', icon: 'ti ti-copy' });
				opt.callback = function(selected) {
					type = selected.id;
					next();
				};

				SETTER('menu/show', opt);
			}
		}

		function uibuilder_settings() {

			cms_hide();

			var path = 'appsettingsform';
			var data = {};
			var schema = app.schema;

			data.id = schema.id;
			data.name = schema.name;
			data.title = schema.title;
			data.author = schema.author;
			data.icon = schema.icon;
			data.type = schema.type;
			data.group = schema.group;
			data.version = schema.version;
			data.reference = schema.reference;
			data.args = schema.args;
			data.editor = schema.editor ? CLONE(schema.editor) : {};
			data.description = schema.description;
			data.css = schema.css;
			data.cssoutput = schema.cssoutput;
			data.csspreview = schema.csspreview;

			SET('appsettingsform @reset', data);
			SET('common.form', path);
		}

		function uibuilder_render() {
			uibuilder_compile(function(meta) {

				var data = meta.editor;

				if (meta.csspreview)
					meta.css = meta.csspreview;

				delete meta.editor;
				delete meta.cssoutput;
				delete meta.csspreview;

				if (common.iframe) {
					SETTER('loading/hide', 500);
					FUNC.send({ TYPE: 'render', data: meta });
					return;
				}

				var url = data.render || data.preview || 'https://preview.totaljs.com';

				if (url) {
					SETTER('loading/hide', 1000);
					var form = $('#uibuilderrender');
					form.attr('action', url);
					form.find('input').val(JSON.stringify(meta));
					form.submit();
				} else
					SETTER('message/warning @hideloading', '@(You do not have defined a render URL address)');
			}, true);
		}

		function uibuilder_contextmenu(el, e) {

			cms_hide();

			var id = ATTRD(el);
			var opt = {};
			var url = app.schema.components[id];
			var isexternal = url.charAt(0) === '@';

			if (isexternal)
				url = url.substring(1).format(id);

			opt.x = e.pageX;
			opt.y = e.pageY;
			opt.align = 'left';
			opt.items = [];
			opt.items.push({ id: 'readme', name: '@(Read information)', icon: 'ti ti-info-circle blue' });

			if (!isexternal) {
				opt.items.push({ id: 'edit', name: '@(Edit source-code)', icon: 'ti ti-code' });
				opt.items.push({ id: 'copy', name: '@(Export)', icon: 'ti ti-file-export' });
			}

			opt.items.push({ id: 'download', name: '@(Download source-code)', icon: 'ti ti-file-code' });

			if (!isexternal)
				opt.items.push({ id: 'remove', name: '@(Remove)', icon: 'ti ti-remove red' });

			opt.callback = function(selected) {
				switch (selected.id) {

					case 'edit':

						var open = function(body) {
							SET('formcode @reset', { id: id, body: body });
							SET('common.form', 'formcode');
						};

						if (url.substring(0, 7) === 'base64 ')
							url = decodeURIComponent(atob(url.substring(7)));
						else if ((/^http(s)?\:/i).test(url)) {
							AJAX('GET {0} ERROR'.format(url), response => open(response));
							return;
						}

						open(url);
						break;

					case 'copy':
						var data = 'uibuilder://' + ENCRYPT({ id: id, url: url.format(id) }, 'uibuilder', 'component');
						EXEC('-clipboard/copy', data);
						EXEC('-notify/success', '@(The component has been copied to the clipboard.)');
						break;

					case 'download':
						var index = url.indexOf(' ');
						if (index === -1) {
							AJAX('GET {0} ERROR'.format(url.format(id)), function(response) {
								SETTER('filesaver/save', id + '.html', response);
							});
						} else
							SETTER('filesaver/save', id + '.html', decodeURIComponent(atob(url.substring(index + 1))));
						break;

					case 'readme':
						var com = app.components[id];
						FUNC.readme(com.name, com.readme || '@(Without readme)');
						break;

					case 'remove':
						var com = app.components[id];

						for (var item of app.instances) {
							if (item.component === com && item.protected) {
								SETTER('message/warning', "@(This component is protected, it can't be removed.)");
								return;
							}
						}

						SETTER('approve/show', '@(Are you sure you want to remove "{0}" component?)'.format(com.name), '"ti ti-remove" @(Remove)', function() {
							delete app.schema.components[id];
							uibuilder_redraw();
						});

						break;
				}
			};
			SETTER('menu/show', opt);
		}

		function uibuilder_device(el) {

			cms_hide();

			var opt = {};
			var sel = common.device || 'auto';
			opt.element = el;
			opt.align = 'left';
			opt.items = [];
			opt.items.push({ id: 'xs', name: '@(Extra small display)', icon: 'ti ti-mobile' });
			opt.items.push({ id: 'sm', name: '@(Small display)', icon: 'ti ti-tablet' });
			opt.items.push({ id: 'md', name: '@(Medium display)', icon: 'ti ti-laptop' });
			opt.items.push({ id: 'lg', name: '@(Large display)', icon: 'ti ti-desktop' });
			opt.items.push('-');
			opt.items.push({ id: 'auto', name: '@(Current browser)', icon: 'ti ti-window' });

			if (sel) {
				for (var item of opt.items)
					item.selected = sel === item.id;
			}

			opt.callback = function(selected) {
				var container = $('#dappcontainer');
				container.rclass2('dm-');
				container.rclass2('d-');
				container.tclass('dm', selected.id !== 'auto');
				container.aclass('dm-' + selected.id);
				container.aclass('d-' + selected.id);
				SET('common.device', selected.id);
				el.find('i').rclass2('ti').aclass(selected.icon);
				UIBuilder.resize();
			};

			SETTER('menu/show', opt);
		}

		function uibuilder_components(el) {

			cms_hide();

			var opt = {};
			opt.element = el;
			opt.items = [];
			opt.items.push({ id: 'components', name: '@(Import components)', icon: 'ti ti-database', classname: 'b' });
			opt.items.push('-');
			opt.items.push({ id: 'add', name: '@(Import custom)', icon: 'ti ti-plus-circle green' });
			opt.items.push({ id: 'create', name: '@(Create)', icon: 'ti ti-code' });

			if (NAV.query.admin) {
				opt.items.push('-');
				opt.items.push({ id: 'widget', name: '@(Import CMS widget)', icon: 'ti ti-layout blue' });
			}

			opt.callback = function(sel) {
				switch (sel.id) {
					case 'create':
						AJAX('GET /template.txt', function(response) {
							var id = 'inline' + GUID(5);
							SET('formcode @reset', { id: id, body: response.replace('.id = \'\'', '.id = \'{0}\''.format(id)) });
							SET('common.form', 'formcode');
						});
						break;
					case 'add':
						uibuilder_addcomponent(el);
						break;
					case 'widget':
						SET('common.form', 'formwidget');
						break;
					case 'components':
						SET('common.form', 'componentsform');
						break;
				}

			};
			SETTER('menu/show', opt);
		}

		function uibuilder_save() {

			cms_hide();

			var meta = CLONE(app.schema);
			var data = app.stringify();

			for (var key in meta.components) {
				var url = meta.components[key];
				if (url.charAt(0) === '@')
					delete meta.components[key];
			}

			meta.children = data.children;
			meta.inputs = app.inputs;
			meta.outputs = app.outputs;

			if (common.iframe) {
				FUNC.send({ TYPE: 'save', data: meta });
				meta.editor.autopublish && uibuilder_publish();
				return;
			}

			if (meta.editor && meta.editor.save) {
				SETTER('approve/show', '@(Are you sure you want to save design?)', '"ti ti-check-circle" @(SAVE)', function() {
					SETTER('loading/show');
					AJAX('POST ' + meta.editor.save + ' urlencoded', { data: JSON.stringify(meta) }, ERROR(ASETTER('notify/success @hideloading', '@(Done, saved!)')));
					meta.editor.autopublish && uibuilder_publish();
				});
			} else {
				SETTER('filesaver/save', meta.name + '_editor.json', JSON.stringify(meta, null, '\t'));
				SETTER('loading/hide', 1000);
			}
		}

		function uibuilder_addcomponent(el) {
			cms_hide();
			SET('formimport @reset', { url: '' });
			SET('common.form', 'formimport');
		}

		function uibuilder_preparerender(com, source) {
			// remove readme
			// remove settings
			return (source || '').replace(/<readme\b[^<]*(?:(?!<\/readme>)<[^<]*)*<\/readme>/gi, '').replace(/<settings\b[^<]*(?:(?!<\/settings>)<[^<]*)*<\/settings>/gi, '').trim();
		}

		function prepare_external_paths(arr) {
			arr = CLONE(arr);
			for (var item of arr)
				item.name = item.name.encode() + (item.type ? '<span class="badge badge-small ml5 monospace" style="background:{0}">{1}</span>'.format(Thelpers.color(item.type), item.type) : '');
			return arr;
		}

		WATCH('app.schema.editor.paths', function(path, value) {

			if (value == null)
				value = '';

			if (common.paths !== value) {
				common.paths = value;
				AJAX('GET ' + value, function(response) {
					response = response instanceof Array ? response.remove(item => !item || !item.name) : [];
					SET('DEF.cl.paths', prepare_external_paths(response));
					uibuilder_rebuildpaths();
				});
			} else {
				SET('DEF.cl.paths', prepare_external_paths((common.iframepaths || []).slice(0)));
				uibuilder_rebuildpaths();
			}
		});

		WATCH('app.schema.editor.codes', function(path, value) {

			if (value == null)
				value = '';

			if (common.codes !== value) {
				common.codes = value;
				AJAX('GET ' + value, function(response) {
					if (response instanceof Array)
						response = response.remove(item => !item || !item.name);
					else
						response = [];
					SET('DEF.cl.codes', response);
				});
			} else
				SET('DEF.cl.codes', (common.iframecodes || []).slice(0));

		});

		WATCH('app.schema.editor.views', function(path, value) {

			if (value == null)
				value = '';

			if (common.views !== value) {
				common.views = value;
				AJAX('GET ' + value, function(response) {
					if (response instanceof Array)
						response = response.remove(item => !item || !item.name);
					else
						response = [];
					SET('DEF.cl.views', response);
					uibuilder_rebuildpaths();
				});
			} else {
				SET('DEF.cl.views', (common.iframeviews || []).slice(0));
				uibuilder_rebuildpaths();
			}

		});

		WATCH('app.schema.editor.apps', function(path, value) {

			if (value == null)
				value = '';

			if (common.apps !== value) {
				common.apps = value;
				AJAX('GET ' + value, function(response) {

					if (response instanceof Array)
						response = response.remove(item => !item || !item.name);
					else
						response = [];

					if (common.iframeapps.slice(0))
						response.push.apply(response, common.iframeapps);

					SET('DEF.cl.apps', response);

					for (var item of app.instances)
						item.events.refresh && item.emit('refresh', { type: 'apps' });

				});

			} else
				SET('DEF.cl.apps', common.iframeapps.slice(0));

		});

		UIBuilder.on('io', function(app) {

			var inputs = CLONE(app.inputs);
			var outputs = CLONE(app.outputs);

			for (var m of inputs) {
				m.text = m.name;
				m.name = m.name + '<span class="badge badge-medium badge-color ml5">{0}</span>'.format(m.component.encode());
			}

			for (var m of outputs) {
				m.text = m.name;
				m.name = m.name + '<span class="badge badge-medium badge-color ml5">{0}</span>'.format(m.component.encode());
			}

			SET('DEF.cl.inputs', app.inputs);
			SET('DEF.cl.outputs', app.outputs);
			SET('DEF.cl.list', app.list);

			uibuilder_rebuildpaths();

		});

		UIBuilder.on('attr', function(el, callback) {
			el = $(el);
			var model = {};
			model.element = el;
			model.title = el.attr('title') || '';
			model.isimage = el[0].tagName === 'IMG';
			model.isiframe = el[0].tagName === 'IFRAME';
			model.id = el.attr('id') || '';
			model.width = el.attr('width') || '';
			model.height = el.attr('height') || '';
			model.src = el.attr('src') || '';
			model.css = el.attr('style') || '';
			model.cls = el.attr('class') || '';
			model.callback = function() {
				if (callback && callback !== NOOP) {
					callback(model.element)
				} else {
					var el = model.element.closest('.UI_component');
					if (el) {
						var instance = el[0].uibuilder;
						instance && instance.emit('html', model.element);
					}
				}
			};
			SET('formattr', model);
			SET('common.form2', 'formattr');
		});

		UIBuilder.on('icon', function(el, callback) {

			el = $(el);

			var com = el.closest('.UI_component');
			var opt = {};

			opt.element = el;
			opt.empty = true;

			opt.callback = function(val) {
				opt.element.rclass2('ti').aclass(val);
				if (callback && callback !== NOOP) {
					callback(opt.element, val);
				} else {
					if (com) {
						if (!val)
							opt.element.remove();
						var instance = com[0].uibuilder;
						instance && instance.emit('html', opt.element);
					}
				}
			};
			SETTER('icons/show', opt);
		});

		UIBuilder.on('link', function(el, callback) {

			el = $(el);

			var model = {};
			var com = el.closest('.UI_component');

			model.element = el;
			model.href = el.attr('href');
			model.target = el.attr('target') || '';
			model.callback = function() {
				if (callback && callback !== NOOP) {
					callback(model.element);
				} else {
					if (com) {
						var instance = com[0].uibuilder;
						instance && instance.emit('html', model.element);
					}
				}
			};

			SET('formlink', model);
			SET('common.form2', 'formlink');
		});

		UIBuilder.on('make', function(instance) {

			cms_hide();

			var readonly = instance.meta.readonly || instance.component.children;

			if (!readonly) {
				var parent = instance.parent;
				while (parent) {
					if (parent.meta.readonly || parent.component.children || parent.component.readonly) {
						readonly = true;
						instance.meta.readonly = true;
						break;
					} else
						parent = parent.parent;
				}
			}

			if (!readonly && !instance.component.floating)
				instance.element.attr('draggable', true);

			var makemenu = function(opt, instance, readonly) {

				opt.items.push(instance.component.name);

				if (instance.component.readme)
					opt.items.push({ id: 'readme', name: '@(Read information)', icon: 'ti ti-info-circle blue', instance: instance });

				if (!readonly)
					opt.items.push({ id: 'settings', name: '@(Settings)', classname: 'b', icon: 'ti ti-cog', instance: instance });

				if (!readonly && !instance.component.floating)
					opt.items.push({ id: 'gap', name: '@(Toggle gap)', selected: instance.element.hclass('UI_gap'), icon: 'ti ti-caret-square-down', instance: instance });

				if (!readonly && instance.component.floating) {
					opt.items.push('-');
					opt.items.push({ id: 'bringfront', name: '@(Bring to front)', icon: 'ti ti-plus-circle green', instance: instance });
					opt.items.push({ id: 'bringback', name: '@(Bring to back)', icon: 'ti ti-minus-circle green', instance: instance });
				}

				if (!readonly && !instance.protected) {
					opt.items.push('-');
					opt.items.push({ id: 'up', name: '@(Move up)', icon: 'ti ti-arrow-up', instance: instance });
					opt.items.push({ id: 'down', name: '@(Move down)', icon: 'ti ti-arrow-down', instance: instance });
					opt.items.push({ id: 'clone', name: '@(Clone)', icon: 'ti ti-clone', instance: instance });
					opt.items.push({ id: 'copy', name: '@(Copy)', icon: 'ti ti-copy', instance: instance });
				}

				if (!readonly) {
					var container = opt.el.closest('.UI_components');
					if (container.length) {
						var ci = container.closest('.UI_component')[0].uibuilder;
						ci && opt.items.push({ id: 'paste', name: '@(Paste to <strong>{0}</strong>)'.format(ci.config.name), icon: 'ti ti-paste', instance: ci, container: container });
					}
				}

				if (!instance.protected && !readonly) {
					opt.items.push('-');
					opt.items.push({ id: 'export', name: '@(Export to component)', icon: 'ti ti-box-up', instance: instance });
				}

				if (!instance.protected && (!readonly || instance.component.children)) {
					opt.items.push('-');
					opt.items.push({ id: 'remove', name: '@(Remove)', icon: 'ti ti-remove red', instance: instance });
				}
			};

			instance.element.on('contextmenu', function(e) {

				cms_hide();

				e.preventDefault();
				e.stopPropagation();

				var opt = {};
				opt.x = e.pageX;
				opt.y = e.pageY;
				opt.items = [];
				opt.el = $(e.target);

				makemenu(opt, instance, readonly);

				if (readonly || instance.component.children) {
					var parentel = instance.element.closest('[draggable]');
					if (parentel.length) {
						var parent = parentel[0].uibuilder;
						opt.items.push('-');
						makemenu(opt, parent, false);
					}
				}

				opt.callback = function(sel) {

					var instance = sel.instance;
					var tmp;

					switch (sel.id) {
						case 'export':
							var meta = app.stringify(instance.element);
							SET('formcomponent @default', { id: 'exp' + Date.now().toString(36) + GUID(2), name: meta.instances[0].config.name, data: meta });
							SET('common.form', 'formcomponent');
							break;
						case 'up':
						case 'down':
							component_move(instance, sel.id === 'up');
							break;
						case 'clone':
							component_clone(instance);
							break;
						case 'copy':
							component_copy(instance);
							break;
						case 'bringfront':
							tmp = +instance.element.css('z-index');
							instance.element.css('z-index', tmp + 1);
							break;
						case 'bringback':
							tmp = +instance.element.css('z-index');
							if (tmp > 1)
								instance.element.css('z-index', tmp - 1);
							break;
						case 'readme':
							var com = instance.component;
							FUNC.readme(com.name, com.readme || '@(Without readme)');
							break;
						case 'gap':
							instance.element.tclass('UI_gap');
							break;
						case 'settings':
							opensettings(instance.element);
							break;
						case 'remove':
							instance.remove();
							break;
						case 'paste':
							SET('formpaste @default', { instance: instance, container: sel.container });
							SET('common.form', 'formpaste');
							break;
					}

				};

				SETTER('menu/show', opt);
			});

		});

		function uibuilder_replace() {
			var opt = {};
			opt.accept = 'application/json';
			opt.callback = function(file) {
				var data = PARSE(file.body);
				if (data && data.name && data.components && data.children) {
					cms_hide();
					SETTER('loading/show');
					var prev = UIBuilder.data || EMPTYOBJECT;
					var id = prev.id || data.id;
					app.remove();
					setTimeout(function() {
						data.id = id;
						UIBuilder.data = data;
						uibuilder_redraw();
					}, 500);
				}
			};
			SETTER('filereader/open', opt);
		}

		function uibuilder_edit() {

			cms_hide();

			var meta = CLONE(app.schema);
			var data = app.stringify();

			for (var key in meta.components) {
				var url = meta.components[key];
				if (url.charAt(0) === '@')
					delete meta.components[key];
			}

			meta.children = data.children;
			meta.inputs = app.inputs;
			meta.outputs = app.outputs;
			SET('formschema @reset', { body: JSON.stringify(meta, null, '\t') });
			SET('common.form', 'formschema');
		}

		function uibuilder_download(element) {

			cms_hide();

			let opt = {};
			opt.element = element;
			opt.align = 'right';
			opt.items = [];
			opt.items.push({ id: 'copy', name: '@(Copy to clipboard)', icon: 'ti ti-copy' });
			opt.items.push({ id: 'download', name: '@(Download)', icon: 'ti ti-download' });
			opt.callback = function(selected) {

				var meta = CLONE(app.schema);
				var data = app.stringify();

				for (var key in meta.components) {
					var url = meta.components[key];
					if (url.charAt(0) === '@')
						delete meta.components[key];
				}

				meta.children = data.children;
				meta.inputs = app.inputs;
				meta.outputs = app.outputs;

				if (selected.id === 'download') {
					SETTER('filesaver/save', meta.name + '_editor.json', JSON.stringify(meta, null, '\t'));
				} else {
					SETTER('clipboard/copy', JSON.stringify(meta, null, '\t'));
					SETTER('notify/success', '@(Copied.)');
				}

				SETTER('loading/hide', 1000);
			};

			SETTER('menu/show', opt);

		}

		function uibuilder_drop_check() {
			if (common.form && common.form !== 'templatesform')
				return false;
			return true;
		}

		function uibuilder_drop(files) {

			cms_hide();

			var arr = [];
			var reload = false;

			for (var file of files)
				arr.push(file);

			SETTER('loading/show');

			arr.wait(function(file, next) {

				var index = file.name.lastIndexOf('.');
				var ext = file.name.substring(index + 1).toLowerCase();
				var reader = new FileReader();

				reader.onload = function() {
					if (ext === 'json') {
						W.app && W.app.clean();
						$('#dapp').empty();
						var data = PARSE(reader.result);
						setTimeout(function() {
							data.id = Date.now().toString(36);
							UIBuilder.data = data;
							uibuilder_redraw();
							NUL('common.form @hideloading');
						}, 500);
						next = null;
					} else {
						var html = reader.result;
						if (html.indexOf('exports.id') !== -1 && html.indexOf('exports.make') !== -1) {
							var match = html.match(/exports\.id.*?(;|\n)/);
							if (match) {
								var obj = {};
								new Function('exports', match[0])(obj);
								if (obj.id) {
									var id = obj.id;
									reload = true;
									app.schema.components[id] = 'base64 ' + btoa(encodeURIComponent(html));
								}
							}
						}
						next();
					}
				};

				reader.readAsText(file);

			}, function() {
				reload && uibuilder_redraw(true);
			});

		}

		function uibuilder_close() {
			FUNC.send({ TYPE: 'close' });
		}

		SETTER(true, 'shortcuts/register', 'F5', function(e) {
			uibuilder_redraw();
		}, true);

		SETTER(true, 'shortcuts/register', 'save', function(e) {
			uibuilder_save();
		}, true);

		// A simple CMS implementation

		function cms_selected(el, type) {

			var panel = $('#CMS_panel');

			if (!el) {
				panel.aclass('hidden');
				SET('*cms', {});
				return;
			}

			var pos = el.offset();

			if (type === 'scroll') {
				if (pos.top < 90) {
					panel.aclass('hidden');
					SET('*cms', {});
					return;
				}
			}

			panel.css({ left: pos.left, top: pos.top - 40 });
			panel.rclass('hidden');

			var findtag = function(el, tag) {

				var node = el[0];

				if (node.tagName === tag)
					return node;

				for (var i = 0; i < 10; i++) {
					node = node.parentNode;
					if (node) {
						if (node.tagName === tag)
							return node;
					} else
						break;
				}
			};

			var opt = {};

			opt.instance = el.closest('.UI_component')[0].uibuilder;
			opt.element = el;
			opt.edit = el.hclass('CMS_edit');
			opt.attrs = opt.edit || el.hclass('CMS_attribute');
			opt.repeat = el.hclass('CMS_repeat');
			opt.link = findtag(el, 'A');
			opt.remove = el.hclass('CMS_remove');
			opt.multiline = el.hclass('CMS_multiline');
			opt.hide = true;

			if (!opt.remove && opt.repeat)
				opt.remove = el.parent().find('> .CMS_repeat').length > 1;

			var buttons = panel.find('nav > button');

			for (var button of buttons)
				$(button).prop('disabled', !opt[button.name]);

			SET('*cms', opt);

			if (type === 'dblclick')
				cms_edit();
		}

		function cms_edit() {

			var obj = GET('*cms');
			var opt = {};

			if (obj.element.hclass('ti')) {
				UIBuilder.emit('icon', obj.element, function(el) {
					obj.instance.emit('cms', el, 'icon');
				});
				return;
			}

			if (obj.element[0].tagName === 'IMG') {
				cms_image();
				return;
			}

			opt.multiline = obj.multiline;
			opt.cms = true;

			setTimeout(function() {
				UIBuilder.edit(obj.element, opt, function(response) {
					response.instance.emit('cms', response.element, 'html');
				});
			}, 100);
		}

		function cms_repeat() {
			var obj = GET('*cms');
			obj.element.rclass('CMS_selected');
			var cloned = obj.element.clone();
			obj.element.aclass('CMS_selected');
			obj.element.after(cloned);
			obj.instance.emit('cms', cloned, 'clone');
			cms_selected(obj.element);
		}

		function cms_remove() {

			var obj = GET('*cms');
			var dom = obj.element[0];

			var index = NODEINDEXOF(dom);
			var parent = dom.parentNode;
			var tmp = parent.children[index + 1];
			if (!tmp)
				tmp = parent.children[index - 1];

			obj.element.remove();
			obj.instance.emit('cms', obj.element, 'remove');

			if (tmp) {
				tmp = $(tmp);
				if (tmp.hclass('CMS_edit') || tmp.hclass('CMS_repeat') || tmp.hclass('CMS_remove') || tmp.hclass('CMS_attribute')) {
					tmp.aclass('CMS_selected');
					cms_selected(tmp);
					return;
				}
			}

			SETTER('uibuildereditor/closecms');
		}

		function cms_attrs() {
			var obj = GET('*cms');
			obj.element.rclass('CMS_selected');
			UIBuilder.emit('attr', obj.element, function(element) {
				element.aclass('CMS_selected');
				cms_selected(element);
				obj.instance.emit('cms', element, 'attrs');
			});
		}

		function cms_image() {
			var obj = GET('*cms');
			var element = obj.element;
			var w = (element.attrd('cms-width') || '').parseFloat();
			var h = (element.attrd('cms-height') || '').parseFloat();

			var opt = {};
			opt.accept = (/^image\/*/);
			opt.element = element;
			opt.isimage = true;
			opt.size = element.attrd('cms-size');
			opt.url = element.attrd('cms-src') || element.attr('src');
			opt.alt = element.attr('alt');
			opt.bg = element.attrd('cms-bg');

			if (w)
				opt.width = w;

			if (h)
				opt.height = h;

			var parent = element.parent('a');
			if (parent.length)
				opt.href = parent.attr('href');

			opt.ishref = !!opt.href;
			opt.callback = function() {
				obj.instance.emit('cms', element, 'image');
			};

			if (opt.width && opt.height) {
				FIND('#imagecrop', com => com.reconfigure('width:{0};height:{1};background:{2}'.format(opt.width, opt.height, opt.bg)));
				SET('formimage @default', opt);
				SET('common.form', 'formimage');
			} else {
				// Upload
				FUNC.upload({ accept: 'image/*' }, function(file) {
					var url = file.url;
					if (opt.size) {
						opt.element.attrd('cms-src', url);
						opt.element.attr('src', url + '?s=' + opt.size.replace('%', ''));
					} else
						opt.element.attr('src', url);
					opt.callback(opt.element);
				});
			}
		}

		function cms_link() {
			var obj = GET('*cms');
			obj.element.rclass('CMS_selected');
			UIBuilder.emit('link', obj.link ? $(obj.link) : obj.element, function(model) {

				if (model.element) {
					model.element.aclass('CMS_selected');
					cms_selected(model.element);
				}

				obj.instance.emit('cms', obj.element, model.element ? 'link' : 'remove');
			});
		}

		function cms_hide() {
			SETTER('uibuildereditor/closecms');
			$('#CMS_panel').aclass('hidden');
		}

		FIND('#mainviewbox', function(com) {
			com.scrollbar.area.on('scroll', function() {
				var cms = common.cms;
				if (cms && cms.element)
					cms_selected(cms.element, 'scroll');
			});
		});

		UIBuilder.on('loading', function(app, percentage) {
			SET('*progress', percentage);
		});

	</script>

</body>
</html>